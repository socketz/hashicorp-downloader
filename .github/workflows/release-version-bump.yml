name: Bump version on release

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Set up Rust (optional)
        uses: dtolnay/rust-toolchain@stable

      - name: Determine bump type
        id: bump
        env:
          TAG: ${{ github.event.release.tag_name || github.ref_name }}
          TITLE: ${{ github.event.release.name || github.event.head_commit.message || '' }}
        run: |
          # Derive bump type from release tag or title (supports release and tag push events)
          TAG="${TAG}"
          TITLE="${TITLE}"
          echo "Tag: $TAG | Title: $TITLE"

          # Priority: explicit suffix in tag -> title keywords -> default patch
          TYPE="patch"
          case "$TAG" in
            *-major|v*-major|*+major) TYPE="major" ;; 
            *-minor|v*-minor|*+minor) TYPE="minor" ;;
            *-patch|v*-patch|*+patch) TYPE="patch" ;;
          esac

          shopt -s nocasematch || true
          if [[ "$TYPE" == "patch" ]]; then
            if [[ "$TITLE" =~ \bmajor\b ]]; then TYPE=major; fi
          fi
          if [[ "$TYPE" == "patch" ]]; then
            if [[ "$TITLE" =~ \bminor\b ]]; then TYPE=minor; fi
          fi
          echo "type=$TYPE" >> $GITHUB_OUTPUT

      - name: Bump Cargo version (${{ steps.bump.outputs.type }})
        id: cargo
        run: |
          python scripts/bump_version.py "${{ steps.bump.outputs.type }}" > new_version.txt
          NEW_VER=$(cat new_version.txt)
          # Try to sync lockfile with cargo if available (no-op if unchanged)
          if command -v cargo >/dev/null 2>&1; then
            cargo update -p hashicorp-downloader || true
          fi
          echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
          echo "Bumped to $NEW_VER"

      - name: Commit changes
        run: |
          NEW_VER="${{ steps.cargo.outputs.new_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B chore/bump-version-$NEW_VER
          git add Cargo.toml Cargo.lock || true
          git commit -m "chore: bump version to $NEW_VER"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          base: master
          branch: chore/bump-version-${{ steps.cargo.outputs.new_version }}
          title: "chore: bump version to ${{ steps.cargo.outputs.new_version }}"
          body: |
            Automated version bump triggered by release `${{ github.event.release.tag_name }}`.
            Bump type: `${{ steps.bump.outputs.type }}`.
          labels: automation, release
